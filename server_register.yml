---
- hosts: "{{ HOSTS is defined | ternary(HOSTS, PREFIX|default('')+'*') }}"
  become: yes
  vars:
    env: Dev
    activation_key: undef
    sat_url: satellite.example.com

  tasks:
  - name: set hostname
    hostname:
      name: "{{ inventory_hostname | regex_replace('_','-')}}"

  - name: remove rhui client packages
    yum:
      name: rh-amazon-rhui-client*
      state: removed

  - name: get current repos
    command:
      cmd: ls /etc/yum.repos.d/
    register: repos
    changed_when: False

  - name: remove existing rhui repos
    file:
      path: "/etc/yum.repos.d/{{ item }}"
      state: absent
    loop: "{{ repos.stdout_lines }}"

  - name: install katello package
    yum:
      name: "https://{{ sat_url }}/pub/katello-ca-consumer-latest.noarch.rpm"
      state: present
      validate_certs: no
      disable_gpg_check: true
    when: sat_url is defined

  - name: register subscription mangler
    redhat_subscription:
      state: present
      activationkey: "{{ activation_key | default('RHEL' + ansible_distribution_major_version + '_' + env)}}"
      org_id: "{{ org_id | default('Default_Organization')}}"
      auto_attach: yes

  - name: install katello agent
    yum:
      name: katello_agent
      state: latest
    when: sat_url is defined
